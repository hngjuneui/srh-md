<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>OpenCV.js Color Detection Test</title>
  <!-- OpenCV.js CDN (버전에 따라 링크 수정 가능) -->
  <script async src="https://docs.opencv.org/4.x/opencv.js" type="text/javascript"></script>
  <style>
    /* 간단한 스타일 */
    #video, #canvas {
      width: 320px;
      height: 240px;
      border: 1px solid #333;
      background: #000;
    }
  </style>
</head>
<body>
  <h1>OpenCV.js Color Detection Test</h1>
  
  <!-- 카메라 영상과 결과 표시 -->
  <div>
    <button onclick="startCamera()">카메라 시작</button>
    <video id="video" autoplay playsinline></video>
    <canvas id="canvas" width="320" height="240" style="display:none"></canvas>
    <p>감지된 색상: <span id="detectedColor">-</span></p>
  </div>

  <script>
    // 미리 정의한 색상 프리셋 (각 색상마다 HSV 범위)
    const presets = {
      "Red": [
        { lower: [0, 100, 100], upper: [10, 255, 255] },
        { lower: [170, 100, 100], upper: [180, 255, 255] }
      ],
      "Orange": [
        { lower: [10, 100, 100], upper: [25, 255, 255] }
      ],
      "Yellow": [
        { lower: [25, 100, 100], upper: [35, 255, 255] }
      ],
      "Green": [
        { lower: [35, 100, 100], upper: [85, 255, 255] }
      ],
      "Blue": [
        { lower: [85, 100, 100], upper: [125, 255, 255] }
      ],
      "Purple": [
        { lower: [125, 100, 100], upper: [145, 255, 255] }
      ],
      "White": [
        { lower: [0, 0, 200], upper: [180, 30, 255] }
      ]
    };

    let video = null;
    let canvas = null;
    let ctx = null;

    // 카메라 시작 및 스트림 연결
    function startCamera() {
      video = document.getElementById("video");
      canvas = document.getElementById("canvas");
      ctx = canvas.getContext('2d');

      navigator.mediaDevices.getUserMedia({ video: true, audio: false })
        .then(stream => {
          video.srcObject = stream;
          video.play();
          console.log("Camera started");
          // OpenCV.js 로딩 후 1초 지연 후 처리 시작
          setTimeout(startProcessing, 1000); 
        })
        .catch(err => {
          console.error("Camera error:", err);
          alert("카메라 접근 실패: " + err);
        });
    }

    // OpenCV.js를 이용한 색상 감지 루프
    function startProcessing() {
      if (typeof cv === 'undefined') {
        console.error("OpenCV.js가 아직 로드되지 않았습니다!");
        alert("OpenCV.js 로딩이 아직 안 된 것 같습니다. 잠시 후 다시 시도하세요.");
        return;
      }
      console.log("OpenCV.js 준비됨. 색상 감지 시작...");

      setInterval(() => {
        if (!video || video.readyState !== video.HAVE_ENOUGH_DATA) return;

        // 1) 현재 프레임을 캔버스에 그리기
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

        // 2) OpenCV Mat 생성 및 프레임 데이터 복사
        let src = new cv.Mat(canvas.height, canvas.width, cv.CV_8UC4);
        let hsv = new cv.Mat(canvas.height, canvas.width, cv.CV_8UC4);
        src.data.set(ctx.getImageData(0, 0, canvas.width, canvas.height).data);

        // 3) RGBA → RGB → HSV 변환
        cv.cvtColor(src, hsv, cv.COLOR_RGBA2RGB);
        cv.cvtColor(hsv, hsv, cv.COLOR_RGB2HSV);

        // 4) 프리셋에 정의된 각 색상별 픽셀 수 계산
        let colorCounts = {};
        for (let color in presets) {
          let totalCount = 0;
          presets[color].forEach(range => {
            totalCount += getColorCount(hsv, range.lower, range.upper);
          });
          colorCounts[color] = totalCount;
        }

        // 5) 픽셀 수가 가장 많은 색상을 감지
        let detected = 'None';
        let maxCount = 0;
        for (let color in colorCounts) {
          if (colorCounts[color] > maxCount) {
            maxCount = colorCounts[color];
            detected = color;
          }
        }

        // 6) 최소 픽셀 수 기준 미달시 'None' 처리
        const threshold = 500;
        if (maxCount < threshold) detected = 'None';

        // 7) 결과 표시
        document.getElementById("detectedColor").innerText = detected;

        src.delete();
        hsv.delete();
      }, 300); // 0.3초마다 처리
    }

    // HSV 범위 내 픽셀 개수를 반환하는 함수
    function getColorCount(hsvMat, lower, upper) {
      let low = new cv.Mat(hsvMat.rows, hsvMat.cols, hsvMat.type(), lower);
      let high = new cv.Mat(hsvMat.rows, hsvMat.cols, hsvMat.type(), upper);
      let mask = new cv.Mat();
      cv.inRange(hsvMat, low, high, mask);
      let count = cv.countNonZero(mask);
      low.delete();
      high.delete();
      mask.delete();
      return count;
    }
  </script>
</body>
</html>
