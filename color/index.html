<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>OpenCV.js Color Detection Test (Mirror Enabled)</title>
  <!-- OpenCV.js CDN (async 제거하여 순차적 로딩) -->
  <script src="https://docs.opencv.org/4.x/opencv.js" type="text/javascript"></script>
  <style>
    #video, #canvas {
      width: 320px;
      height: 240px;
      border: 1px solid #333;
      background: #000;
      margin: 5px;
    }
  </style>
</head>
<body>
  <h1>OpenCV.js Color Detection Test (Mirror Enabled)</h1>
  
  <div>
    <button onclick="startCamera()">카메라 시작</button>
    <br>
    <video id="video" autoplay playsinline></video>
    <canvas id="canvas" width="320" height="240"></canvas>
    <p>감지된 색상: <span id="detectedColor">-</span></p>
  </div>

  <script>
    // 미리 정의한 색상 프리셋 (HSV 범위)
    const presets = {
      "Red": [
        { lower: [0, 100, 100], upper: [10, 255, 255] },
        { lower: [170, 100, 100], upper: [180, 255, 255] }
      ],
      "Orange": [
        { lower: [10, 100, 100], upper: [25, 255, 255] }
      ],
      "Yellow": [
        { lower: [25, 100, 100], upper: [35, 255, 255] }
      ],
      "Green": [
        { lower: [35, 100, 100], upper: [85, 255, 255] }
      ],
      "Blue": [
        { lower: [85, 100, 100], upper: [125, 255, 255] }
      ],
      "Purple": [
        { lower: [125, 100, 100], upper: [145, 255, 255] }
      ],
      "White": [
        { lower: [0, 0, 200], upper: [180, 30, 255] }
      ]
    };

    let video, canvas, ctx;

    function startCamera() {
      video = document.getElementById("video");
      canvas = document.getElementById("canvas");
      ctx = canvas.getContext('2d');

      navigator.mediaDevices.getUserMedia({ video: true, audio: false })
        .then(stream => {
          video.srcObject = stream;
          video.play();
          console.log("Camera started");

          // OpenCV.js 초기화 여부 확인
          if (typeof cv.getBuildInformation === "function") {
            console.log("OpenCV 이미 초기화됨.");
            requestAnimationFrame(processFrame);
          } else {
            cv.onRuntimeInitialized = () => {
              console.log("OpenCV.js 초기화 완료.");
              requestAnimationFrame(processFrame);
            };
          }
        })
        .catch(err => {
          console.error("Camera error:", err);
          alert("카메라 접근 실패: " + err);
        });
    }

    function processFrame() {
      // video가 준비되었는지 체크
      if(video.readyState === video.HAVE_ENOUGH_DATA) {
        // 캔버스 클리어
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        // 좌우 반전을 위한 transform 적용
        ctx.save();
        ctx.translate(canvas.width, 0);
        ctx.scale(-1, 1);
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        ctx.restore();

        // 현재 캔버스의 이미지 데이터를 가져와 OpenCV Mat 생성
        let imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        let src = cv.matFromImageData(imageData);
        let hsv = new cv.Mat();
        cv.cvtColor(src, hsv, cv.COLOR_RGBA2RGB);
        cv.cvtColor(hsv, hsv, cv.COLOR_RGB2HSV);

        // 각 프리셋 별 픽셀 개수 계산
        let colorCounts = {};
        for (let color in presets) {
          let totalCount = 0;
          presets[color].forEach(range => {
            totalCount += getColorCount(hsv, range.lower, range.upper);
          });
          colorCounts[color] = totalCount;
        }

        // 가장 많은 픽셀이 검출된 색상 결정
        let detected = 'None';
        let maxCount = 0;
        for (let color in colorCounts) {
          if (colorCounts[color] > maxCount) {
            maxCount = colorCounts[color];
            detected = color;
          }
        }
        // 임계값 미달 시 'None' 처리
        const threshold = 500;
        if (maxCount < threshold) detected = 'None';
        document.getElementById("detectedColor").innerText = detected;

        // 텍스트 오버레이 (캔버스 좌표는 미러 효과와 무관하게 표시)
        ctx.save();
        ctx.setTransform(1, 0, 0, 1, 0, 0);
        ctx.font = "20px Arial";
        ctx.fillStyle = "red";
        ctx.fillText(detected, 10, 30);
        ctx.restore();

        src.delete();
        hsv.delete();
      }
      // 다음 프레임 처리
      requestAnimationFrame(processFrame);
    }

    // HSV 범위 내 픽셀 개수 계산 함수
    function getColorCount(hsvMat, lower, upper) {
      let low = new cv.Mat(hsvMat.rows, hsvMat.cols, hsvMat.type(), lower);
      let high = new cv.Mat(hsvMat.rows, hsvMat.cols, hsvMat.type(), upper);
      let mask = new cv.Mat();
      cv.inRange(hsvMat, low, high, mask);
      let count = cv.countNonZero(mask);
      low.delete();
      high.delete();
      mask.delete();
      return count;
    }
  </script>
</body>
</html>
