<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>OpenCV.js Color Detection Test</title>
  <!-- OpenCV.js CDN (async 제거하여 순차적 로딩 가능) -->
  <script src="https://docs.opencv.org/4.x/opencv.js" type="text/javascript"></script>
  <style>
    #video, #canvas {
      width: 320px;
      height: 240px;
      border: 1px solid #333;
      background: #000;
      margin: 5px;
    }
  </style>
</head>
<body>
  <h1>OpenCV.js Color Detection Test</h1>
  
  <div>
    <button onclick="startCamera()">카메라 시작</button>
    <br>
    <video id="video" autoplay playsinline></video>
    <canvas id="canvas" width="320" height="240"></canvas>
    <p>감지된 색상: <span id="detectedColor">-</span></p>
  </div>

  <script>
    // 미리 정의한 색상 프리셋 (각 색상마다 HSV 범위)
    const presets = {
      "Red": [
        { lower: [0, 100, 100], upper: [10, 255, 255] },
        { lower: [170, 100, 100], upper: [180, 255, 255] }
      ],
      "Orange": [
        { lower: [10, 100, 100], upper: [25, 255, 255] }
      ],
      "Yellow": [
        { lower: [25, 100, 100], upper: [35, 255, 255] }
      ],
      "Green": [
        { lower: [35, 100, 100], upper: [85, 255, 255] }
      ],
      "Blue": [
        { lower: [85, 100, 100], upper: [125, 255, 255] }
      ],
      "Purple": [
        { lower: [125, 100, 100], upper: [145, 255, 255] }
      ],
      "White": [
        { lower: [0, 0, 200], upper: [180, 30, 255] }
      ]
    };

    let video, canvas, ctx;

    function startCamera() {
      video = document.getElementById("video");
      canvas = document.getElementById("canvas");
      ctx = canvas.getContext('2d');

      navigator.mediaDevices.getUserMedia({ video: true, audio: false })
        .then(stream => {
          video.srcObject = stream;
          video.play();
          console.log("Camera started");
          // OpenCV 초기화 여부 확인
          if (typeof cv.getBuildInformation === "function") {
            console.log("OpenCV 이미 초기화됨.");
            startProcessing();
          } else {
            cv.onRuntimeInitialized = () => {
              console.log("OpenCV.js 초기화 완료.");
              startProcessing();
            };
          }
        })
        .catch(err => {
          console.error("Camera error:", err);
          alert("카메라 접근 실패: " + err);
        });
    }

    function startProcessing() {
      console.log("색상 감지 루프 시작.");
      setInterval(() => {
        if (!video || video.readyState !== video.HAVE_ENOUGH_DATA) return;

        // 1) video 프레임을 canvas에 그리기
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        let imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        // cv.matFromImageData()를 이용하여 OpenCV Mat 생성 (OpenCV.js v4.x 이상)
        let src = cv.matFromImageData(imageData);
        let hsv = new cv.Mat();
        cv.cvtColor(src, hsv, cv.COLOR_RGBA2RGB);
        cv.cvtColor(hsv, hsv, cv.COLOR_RGB2HSV);

        // 2) 프리셋에 정의된 각 색상별 픽셀 수 계산
        let colorCounts = {};
        for (let color in presets) {
          let totalCount = 0;
          presets[color].forEach(range => {
            totalCount += getColorCount(hsv, range.lower, range.upper);
          });
          colorCounts[color] = totalCount;
        }

        // 3) 가장 많은 픽셀 수를 가진 색상 찾기
        let detected = 'None';
        let maxCount = 0;
        for (let color in colorCounts) {
          if (colorCounts[color] > maxCount) {
            maxCount = colorCounts[color];
            detected = color;
          }
        }

        // 4) 최소 픽셀 수 기준 미달 시 'None'
        const threshold = 500;
        if (maxCount < threshold) detected = 'None';
        document.getElementById("detectedColor").innerText = detected;
        
        // 5) 처리된 프레임 위에 감지된 색상 텍스트 오버레이
        ctx.font = "20px Arial";
        ctx.fillStyle = "red";
        ctx.fillText(detected, 10, 30);

        src.delete();
        hsv.delete();
      }, 300);
    }

    // HSV 범위 내 픽셀 개수 계산 함수
    function getColorCount(hsvMat, lower, upper) {
      let low = new cv.Mat(hsvMat.rows, hsvMat.cols, hsvMat.type(), lower);
      let high = new cv.Mat(hsvMat.rows, hsvMat.cols, hsvMat.type(), upper);
      let mask = new cv.Mat();
      cv.inRange(hsvMat, low, high, mask);
      let count = cv.countNonZero(mask);
      low.delete();
      high.delete();
      mask.delete();
      return count;
    }
  </script>
</body>
</html>
