<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ì›¹ AI í¬ì¦ˆ ëª¨ë¸ ì¡°ì¢…ê¸°</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background-color: #f2f2f7;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
      color: #1c1c1e;
      margin: 0;
    }

    .main-container {
      width: 100%;
      max-width: 420px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    h2 {
      font-size: 1.5em;
      color: #007aff;
      font-weight: 600;
      margin-bottom: 10px;
    }

    canvas {
      border-radius: 16px;
      margin-top: 10px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      max-width: 100%;
      width: 100%;
      height: auto;
      display: block;
    }

    #status-box {
      margin-top: 10px;
      padding: 10px;
      border-radius: 12px;
      background-color: #ffffff;
      border: 1px solid #ccc;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
      max-width: 400px;
      width: 100%;
      text-align: center;
      font-size: 0.9em;
    }

    pre#log {
      margin-top: 15px;
      background: #ffffff;
      padding: 14px 18px;
      width: 100%;
      max-width: 400px;
      height: 70px;
      overflow-y: auto;
      border-radius: 12px;
      border: 1px solid #d1d1d6;
      font-size: 0.9em;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
      white-space: pre-wrap;
    }

    button {
      width: 100%;
      max-width: 400px;
      padding: 12px;
      margin: 10px 0;
      border: none;
      border-radius: 12px;
      background-color: #007aff;
      color: white;
      font-size: 1em;
      font-weight: 500;
      cursor: pointer;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      transition: background-color 0.3s ease;
    }

    button:hover {
      background-color: #005ecb;
    }

    video.hidden {
      display: none;
    }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose@0.5/pose.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.min.js"></script>
</head>
<body>
  <h2>ì›¹ AI í¬ì¦ˆ ëª¨ë¸ ì¡°ì¢…ê¸°</h2>
  <div id="status-box">
    <div id="status">í™”ë©´ì„ í„°ì¹˜í•˜ì—¬ ê¸°ê¸° ê²€ìƒ‰...</div>
  </div>
  <canvas id="outputCanvas"></canvas>
  <pre id="log"></pre>
  <video id="camera" autoplay playsinline class="hidden"></video>

  <script>
    let device;
    let writeCharacteristic;
    let sentState = { left: false, right: false };

    // ì¶”ê°€: ì „ì†¡ ì¼ì‹œì¤‘ì§€ ë° ê·¼ì ‘ ì „ì†¡ ì¸í„°ë²Œ ê´€ë ¨ ë³€ìˆ˜
    let pauseTransmission = false;
    let proximityInterval = null;
    let proximityDirection = null;

    const log = (msg) => {
      const el = document.getElementById('log');
      el.textContent += msg + '\n';
      el.scrollTop = el.scrollHeight;
    };

    const updateStatus = (text) => {
      document.getElementById('status').textContent = 'ìƒíƒœ: ' + text;
    };

    async function connectBLE() {
      try {
        device = await navigator.bluetooth.requestDevice({
          acceptAllDevices: true,
          optionalServices: ['00c0ffee-1234-1234-1234-123456789abc']
        });
        const server = await device.gatt.connect();
        const service = await server.getPrimaryService('00c0ffee-1234-1234-1234-123456789abc');
        writeCharacteristic = await service.getCharacteristic('00c0ffee-4321-4321-4321-cba987654321');
        log('BLE ì—°ê²° ì„±ê³µ: ' + device.name);
        updateStatus('ì—°ê²°ë¨ (' + device.name + ')');

        device.addEventListener('gattserverdisconnected', () => {
          log('BLE ì—°ê²° ëŠê¹€.');
          updateStatus('ì—°ê²° ëŠê¹€');
          writeCharacteristic = null;
        });
      } catch (e) {
        log('BLE ì—°ê²° ì‹¤íŒ¨: ' + e);
        updateStatus('ì—°ê²° ì‹¤íŒ¨');
      }
    }

    function sendMessage(label, msg) {
      if (!writeCharacteristic) return;
      const encoder = new TextEncoder();
      writeCharacteristic.writeValue(encoder.encode(msg + '\n'))
        .then(() => log([${label}] ì „ì†¡: ${msg}))
        .catch(err => log([${label}] ì „ì†¡ ì‹¤íŒ¨: ${err}));
    }

    const videoElement = document.getElementById('camera');
    const canvasElement = document.getElementById('outputCanvas');
    const canvasCtx = canvasElement.getContext('2d');

    function adjustCanvasSize() {
      if (videoElement.videoWidth && videoElement.videoHeight) {
        canvasElement.width = videoElement.videoWidth;
        canvasElement.height = videoElement.videoHeight;
      }
    }

    // ì¶”ê°€: ê·¼ì ‘ ì „ì†¡ ì¸í„°ë²Œ í•´ì œ í•¨ìˆ˜
    function clearProximityInterval() {
      if (proximityInterval) {
        clearInterval(proximityInterval);
        proximityInterval = null;
        proximityDirection = null;
      }
    }

    const pose = new Pose({
      locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`
    });

    pose.setOptions({
      modelComplexity: 1,
      smoothLandmarks: true,
      enableSegmentation: false,
      minDetectionConfidence: 0.5,
      minTrackingConfidence: 0.5
    });

    pose.onResults(results => {
      adjustCanvasSize();
      canvasCtx.save();
      canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
      canvasCtx.translate(canvasElement.width, 0);
      canvasCtx.scale(-1, 1);
      canvasCtx.drawImage(videoElement, 0, 0, canvasElement.width, canvasElement.height);

      if (results.poseLandmarks) {
        const landmarks = results.poseLandmarks;
        const leftShoulder = landmarks[11];
        const rightShoulder = landmarks[12];
        const leftElbow = landmarks[13];
        const rightElbow = landmarks[14];
        const leftWrist = landmarks[15];
        const rightWrist = landmarks[16];

        // ì¶”ê°€: í™”ë©´ ë°– íŒì •
        const outOfBounds =
          leftWrist.x < 0 || leftWrist.x > 1 || leftWrist.y < 0 || leftWrist.y > 1 ||
          rightWrist.x < 0 || rightWrist.x > 1 || rightWrist.y < 0 || rightWrist.y > 1;

        if (outOfBounds) {
          if (!pauseTransmission) {
            pauseTransmission = true;
            clearProximityInterval();
            log('âš ï¸ ì£¼ë¨¹ì´ í™”ë©´ ë°–ìœ¼ë¡œ ë²—ì–´ë‚¨ â†’ ì „ì†¡ ì¤‘ì§€');
          }
          canvasCtx.restore();
          return;
        } else if (pauseTransmission) {
          pauseTransmission = false;
          log('âœ… ì£¼ë¨¹ì´ í™”ë©´ ì•ˆìœ¼ë¡œ ë³µê·€ â†’ ì „ì†¡ ì¬ê°œ');
        }

        const drawLine = (a, b, color) => {
          canvasCtx.beginPath();
          canvasCtx.moveTo(a.x * canvasElement.width, a.y * canvasElement.height);
          canvasCtx.lineTo(b.x * canvasElement.width, b.y * canvasElement.height);
          canvasCtx.strokeStyle = color;
          canvasCtx.lineWidth = 4;
          canvasCtx.stroke();
        };

        drawLine(leftShoulder, rightShoulder, '#00FF00');
        drawLine(leftShoulder, leftElbow, '#FF0000');
        drawLine(leftElbow, leftWrist, '#FF0000');
        drawLine(rightShoulder, rightElbow, '#0000FF');
        drawLine(rightElbow, rightWrist, '#0000FF');

        const shoulderY = (leftShoulder.y + rightShoulder.y) / 2 * canvasElement.height;

        if (!pauseTransmission) {
          if (!sentState.left && leftWrist.y * canvasElement.height < shoulderY) {
            sendMessage('LEFT', '4');
            sentState.left = true;
            log('ì™¼ì† ìœ„ë¡œ ì˜¬ë¦¼ â†’ 4 ì „ì†¡');
          } else if (leftWrist.y * canvasElement.height > shoulderY + 20) {
            sentState.left = false;
          }

          if (!sentState.right && rightWrist.y * canvasElement.height < shoulderY) {
            sendMessage('RIGHT', '6');
            sentState.right = true;
            log('ì˜¤ë¥¸ì† ìœ„ë¡œ ì˜¬ë¦¼ â†’ 6 ì „ì†¡');
          } else if (rightWrist.y * canvasElement.height > shoulderY + 20) {
            sentState.right = false;
          }
        }

        // ì¶”ê°€: ì£¼ë¨¹ ê·¼ì ‘(8/2) ì „ì†¡ ë¡œì§
        if (!pauseTransmission) {
          const x1 = leftWrist.x * canvasElement.width;
          const y1 = leftWrist.y * canvasElement.height;
          const x2 = rightWrist.x * canvasElement.width;
          const y2 = rightWrist.y * canvasElement.height;
          const dist = Math.hypot(x1 - x2, y1 - y2);
          const closeThreshold = 60;  // í”½ì…€ ë‹¨ìœ„ ì„ê³„ì¹˜

          if (dist < closeThreshold) {
            const avgY = (y1 + y2) / 2;
            const region = (avgY > canvasElement.height / 2) ? 'bottom' : 'top';
            const msg = region === 'bottom' ? '8' : '2';

            if (!proximityInterval || proximityDirection !== region) {
              clearProximityInterval();
              proximityDirection = region;
              sendMessage('PROX', msg);
              proximityInterval = setInterval(() => {
                if (!pauseTransmission) sendMessage('PROX', msg);
              }, 500);
              log(`âœ‹ ì£¼ë¨¹ ê·¼ì ‘ â†’ ${msg} ì „ì†¡(ì—°ì†)`);
            }
          } else {
            if (proximityInterval) {
              clearProximityInterval();
              log('ğŸ¤ ì£¼ë¨¹ ë¶„ë¦¬ â†’ ê·¼ì ‘ ì „ì†¡ ì¤‘ë‹¨');
            }
          }
        }
      }

      canvasCtx.restore();
    });

    async function startCamera() {
      const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } });
      videoElement.srcObject = stream;
      videoElement.play();
      videoElement.onloadedmetadata = () => adjustCanvasSize();
    }

    const camera = new Camera(videoElement, {
      onFrame: async () => {
        await pose.send({ image: videoElement });
      },
      width: 480,
      height: 640
    });

    window.onload = async () => {
      await startCamera();
      camera.start();

      if (navigator.bluetooth) {
        log('BLEë¥¼ ì—°ê²°í•˜ë ¤ë©´ í™”ë©´ì„ í´ë¦­í•˜ì„¸ìš”.');
        updateStatus('ì—°ê²° ëŒ€ê¸° ì¤‘');
        document.body.addEventListener('click', async () => {
          if (!writeCharacteristic) {
            await connectBLE();
          }
        }, { once: true });
      } else {
        log('ì´ ë¸Œë¼ìš°ì €ëŠ” Web Bluetoothë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
        updateStatus('ë¯¸ì§€ì›');
      }
    };
  </script>

  <div style="width: 100%; max-width: 400px; text-align: center; padding: 10px 0; margin-top: 20px; font-size: 0.8em; color: #8e8e93;">
    <hr style="border: none; border-top: 1px solid #d1d1d6; margin: 10px 0;">
    2025 Teacher Jun, Dept. of Robotics Mechanical Design, Seoul Robotics Highschool
  </div>
</body>
</html>
