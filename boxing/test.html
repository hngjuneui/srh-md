<script>
// ... 기존 코드 상단 생략 ...
pose.onResults(results => {
  adjustCanvasSize();
  canvasCtx.save();
  canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
  canvasCtx.translate(canvasElement.width, 0);
  canvasCtx.scale(-1, 1);
  canvasCtx.drawImage(videoElement, 0, 0, canvasElement.width, canvasElement.height);

  if (results.poseLandmarks) {
    const landmarks = results.poseLandmarks;
    const leftShoulder = landmarks[11];
    const rightShoulder = landmarks[12];
    const leftWrist = landmarks[15];
    const rightWrist = landmarks[16];

    const canvasW = canvasElement.width;
    const canvasH = canvasElement.height;

    const midY = (leftShoulder.y + rightShoulder.y) / 2 * canvasH;

    const leftY = leftWrist.y * canvasH;
    const rightY = rightWrist.y * canvasH;
    const leftX = leftWrist.x * canvasW;
    const rightX = rightWrist.x * canvasW;

    // 기존 4, 6 동작 유지
    if (!sentState.left && leftY < midY) {
      sendMessage('LEFT', '4');
      sentState.left = true;
      log('왼손 위로 올림 → 4 전송');
    } else if (leftY > midY + 20) {
      sentState.left = false;
    }

    if (!sentState.right && rightY < midY) {
      sendMessage('RIGHT', '6');
      sentState.right = true;
      log('오른손 위로 올림 → 6 전송');
    } else if (rightY > midY + 20) {
      sentState.right = false;
    }

    // 요청 1: 하단부 X자 → 8 지속 전송
    const isXCrossBottom = leftX > rightX && leftY > midY + canvasH * 0.25 && rightY > midY + canvasH * 0.25;
    if (isXCrossBottom) {
      sendMessage('FORWARD', '8');
    }

    // 요청 2: 상단부 X자 → 2 지속 전송
    const isXCrossTop = leftX > rightX && leftY < midY - canvasH * 0.25 && rightY < midY - canvasH * 0.25;
    if (isXCrossTop) {
      sendMessage('BACKWARD', '2');
    }
  }

  canvasCtx.restore();
});
</script>
