<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ì›¹ AI í¬ì¦ˆ ëª¨ë¸ ì¡°ì¢…ê¸°</title>
  <style>
    /* ê¸°ì¡´ ìŠ¤íƒ€ì¼ ê·¸ëŒ€ë¡œ ìœ ì§€ */
    body { /* ... */ }
    .main-container { /* ... */ }
    /* ì´í•˜ ìƒëµ */
  </style>

  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose@0.5/pose.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.min.js"></script>
</head>
<body>
  <h2>ì›¹ AI í¬ì¦ˆ ëª¨ë¸ ì¡°ì¢…ê¸°</h2>
  <div id="status-box">
    <div id="status">í™”ë©´ì„ í„°ì¹˜í•˜ì—¬ ê¸°ê¸° ê²€ìƒ‰...</div>
  </div>
  <canvas id="outputCanvas"></canvas>
  <pre id="log"></pre>
  <video id="camera" autoplay playsinline class="hidden"></video>

  <script>
    let device;
    let writeCharacteristic;
    let sentState = { left: false, right: false };

    // --- ì¶”ê°€: ì „ì†¡ ì¼ì‹œì¤‘ì§€ í”Œë˜ê·¸ & ê·¼ì ‘ ì „ì†¡ ì¸í„°ë²Œ ë³€ìˆ˜
    let pauseTransmission = false;
    let proximityInterval = null;
    let proximityDirection = null;

    const log = (msg) => {
      const el = document.getElementById('log');
      el.textContent += msg + '\n';
      el.scrollTop = el.scrollHeight;
    };
    const updateStatus = (text) => {
      document.getElementById('status').textContent = 'ìƒíƒœ: ' + text;
    };

    async function connectBLE() { /* ê¸°ì¡´ BLE ì—°ê²° ë¡œì§ */ }

    function sendMessage(label, msg) {
      if (!writeCharacteristic) return;
      const encoder = new TextEncoder();
      writeCharacteristic.writeValue(encoder.encode(msg + '\n'))
        .then(() => log(`[${label}] ì „ì†¡: ${msg}`))
        .catch(err => log(`[${label}] ì „ì†¡ ì‹¤íŒ¨: ${err}`));
    }

    const videoElement = document.getElementById('camera');
    const canvasElement = document.getElementById('outputCanvas');
    const canvasCtx = canvasElement.getContext('2d');

    function adjustCanvasSize() {
      if (videoElement.videoWidth && videoElement.videoHeight) {
        canvasElement.width = videoElement.videoWidth;
        canvasElement.height = videoElement.videoHeight;
      }
    }

    // --- ì¶”ê°€: ê·¼ì ‘ ì¸í„°ë²Œ í•´ì œ í•¨ìˆ˜
    function clearProximityInterval() {
      if (proximityInterval) {
        clearInterval(proximityInterval);
        proximityInterval = null;
        proximityDirection = null;
      }
    }

    const pose = new Pose({
      locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`
    });
    pose.setOptions({ /* ê¸°ì¡´ ì˜µì…˜ */ });

    pose.onResults(results => {
      adjustCanvasSize();
      canvasCtx.save();
      canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
      canvasCtx.translate(canvasElement.width, 0);
      canvasCtx.scale(-1, 1);
      canvasCtx.drawImage(videoElement, 0, 0, canvasElement.width, canvasElement.height);

      if (results.poseLandmarks) {
        const landmarks = results.poseLandmarks;
        const leftShoulder = landmarks[11];
        const rightShoulder = landmarks[12];
        const leftElbow = landmarks[13];
        const rightElbow = landmarks[14];
        const leftWrist = landmarks[15];
        const rightWrist = landmarks[16];

        // í™”ë©´ ë°– íŒì •
        const outOfBounds =
          leftWrist.x < 0 || leftWrist.x > 1 || leftWrist.y < 0 || leftWrist.y > 1 ||
          rightWrist.x < 0 || rightWrist.x > 1 || rightWrist.y < 0 || rightWrist.y > 1;

        if (outOfBounds) {
          if (!pauseTransmission) {
            pauseTransmission = true;
            clearProximityInterval();
            log('âš ï¸ ì£¼ë¨¹ì´ í™”ë©´ ë°–ìœ¼ë¡œ ë²—ì–´ë‚¨ â†’ ì „ì†¡ ì¤‘ì§€');
          }
          canvasCtx.restore();
          return;
        } else if (pauseTransmission) {
          pauseTransmission = false;
          log('âœ… ì£¼ë¨¹ì´ í™”ë©´ ì•ˆìœ¼ë¡œ ë³µê·€ â†’ ì „ì†¡ ì¬ê°œ');
        }

        // ëœë“œë§ˆí¬ ì„  ê·¸ë¦¬ê¸° (ê¸°ì¡´)
        const drawLine = (a, b, color) => {
          canvasCtx.beginPath();
          canvasCtx.moveTo(a.x * canvasElement.width, a.y * canvasElement.height);
          canvasCtx.lineTo(b.x * canvasElement.width, b.y * canvasElement.height);
          canvasCtx.strokeStyle = color;
          canvasCtx.lineWidth = 4;
          canvasCtx.stroke();
        };
        drawLine(leftShoulder, rightShoulder, '#00FF00');
        drawLine(leftShoulder, leftElbow, '#FF0000');
        drawLine(leftElbow, leftWrist, '#FF0000');
        drawLine(rightShoulder, rightElbow, '#0000FF');
        drawLine(rightElbow, rightWrist, '#0000FF');

        const shoulderY = (leftShoulder.y + rightShoulder.y) / 2 * canvasElement.height;

        // 4Â·6 ì „ì†¡ ë¡œì§ (ê¸°ì¡´)
        if (!pauseTransmission) {
          if (!sentState.left && leftWrist.y * canvasElement.height < shoulderY) {
            sendMessage('LEFT', '4');
            sentState.left = true;
            log('ì™¼ì† ìœ„ë¡œ ì˜¬ë¦¼ â†’ 4 ì „ì†¡');
          } else if (leftWrist.y * canvasElement.height > shoulderY + 20) {
            sentState.left = false;
          }
          if (!sentState.right && rightWrist.y * canvasElement.height < shoulderY) {
            sendMessage('RIGHT', '6');
            sentState.right = true;
            log('ì˜¤ë¥¸ì† ìœ„ë¡œ ì˜¬ë¦¼ â†’ 6 ì „ì†¡');
          } else if (rightWrist.y * canvasElement.height > shoulderY + 20) {
            sentState.right = false;
          }
        }

        // --- ì¶”ê°€: ì£¼ë¨¹ ê·¼ì ‘(8/2) ì „ì†¡ ë¡œì§
        if (!pauseTransmission) {
          const x1 = leftWrist.x * canvasElement.width;
          const y1 = leftWrist.y * canvasElement.height;
          const x2 = rightWrist.x * canvasElement.width;
          const y2 = rightWrist.y * canvasElement.height;
          const dist = Math.hypot(x1 - x2, y1 - y2);
          const closeThreshold = 60;  // í”½ì…€ ë‹¨ìœ„ ì„ê³„ì¹˜

          if (dist < closeThreshold) {
            const avgY = (y1 + y2) / 2;
            const region = (avgY > canvasElement.height / 2) ? 'bottom' : 'top';
            const msg = region === 'bottom' ? '8' : '2';

            if (!proximityInterval || proximityDirection !== region) {
              clearProximityInterval();
              proximityDirection = region;
              sendMessage('PROX', msg);
              proximityInterval = setInterval(() => {
                if (!pauseTransmission) sendMessage('PROX', msg);
              }, 500);
              log(`âœ‹ ì£¼ë¨¹ ê·¼ì ‘ â†’ ${msg} ì „ì†¡(ì—°ì†)`);
            }
          } else {
            if (proximityInterval) {
              clearProximityInterval();
              log('ğŸ¤ ì£¼ë¨¹ ë¶„ë¦¬ â†’ ê·¼ì ‘ ì „ì†¡ ì¤‘ë‹¨');
            }
          }
        }
      }

      canvasCtx.restore();
    });

    async function startCamera() { /* ê¸°ì¡´ */ }
    const camera = new Camera(videoElement, { /* ê¸°ì¡´ */ });

    window.onload = async () => {
      await startCamera();
      camera.start();
      if (navigator.bluetooth) {
        log('BLEë¥¼ ì—°ê²°í•˜ë ¤ë©´ í™”ë©´ì„ í´ë¦­í•˜ì„¸ìš”.');
        updateStatus('ì—°ê²° ëŒ€ê¸° ì¤‘');
        document.body.addEventListener('click', async () => {
          if (!writeCharacteristic) await connectBLE();
        }, { once: true });
      } else {
        log('ì´ ë¸Œë¼ìš°ì €ëŠ” Web Bluetoothë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
        updateStatus('ë¯¸ì§€ì›');
      }
    };
  </script>

  <div style="/* Footer */">
    2025 Teacher Jun, Dept. of Robotics Mechanical Design, Seoul Robotics Highschool
  </div>
</body>
</html>
