<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <title>MediaPipe BLE RC Car Controller</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            overscroll-behavior: none;
        }

        .container {
            width: 100%;
            max-width: 420px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 30px;
        }

        h1 {
            text-align: center;
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.8em;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }

        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        button {
            padding: 12px 20px;
            font-size: 15px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            transition: all 0.3s ease;
            font-weight: 600;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        button:disabled {
            background: #cccccc;
            cursor: not-allowed;
            box-shadow: none;
        }

        .video-container {
            position: relative;
            width: 100%;
            max-width: 400px;
            margin: 0 auto 20px;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        }

        video {
            display: none;
        }

        canvas {
            width: 100%;
            display: block;
        }

        .status-panel {
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .status-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            margin-bottom: 8px;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 12px;
            font-size: 14px;
        }

        .status-item:last-child {
            margin-bottom: 0;
        }

        .status-label {
            font-weight: 600;
            color: #764ba2;
        }

        .status-value {
            font-weight: 700;
            color: #667eea;
            padding: 4px 12px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 8px;
        }

        .log-panel {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            border-radius: 20px;
            padding: 20px;
            max-height: 200px;
            overflow-y: auto;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .log-item {
            padding: 8px 12px;
            margin-bottom: 6px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 10px;
            font-size: 13px;
            color: #555;
            border-left: 4px solid #667eea;
        }

        .ble-status {
            text-align: center;
            padding: 12px;
            border-radius: 15px;
            margin-bottom: 15px;
            font-weight: 600;
            font-size: 15px;
        }

        .ble-connected {
            background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%);
            color: #0f5132;
        }

        .ble-disconnected {
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            color: #842029;
        }

        .legend {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 12px;
            font-size: 13px;
            font-weight: 600;
        }

        .legend-color {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            border: 2px solid rgba(0, 0, 0, 0.2);
        }

        .footer {
            width: 100%;
            max-width: 400px;
            text-align: center;
            padding: 20px 0;
            margin-top: 20px;
            font-size: 0.75em;
            color: rgba(255, 255, 255, 0.7);
        }

        .footer hr {
            border: none;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            margin: 15px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöó RC Car Controller</h1>
        
        <div class="controls">
            <button id="connectBtn">BLE Ïó∞Í≤∞</button>
            <button id="startBtn" disabled>Ïπ¥Î©îÎùº ÏãúÏûë</button>
        </div>

        <div id="bleStatus" class="ble-status ble-disconnected">
            BLE Ïó∞Í≤∞ ÏïàÎê®
        </div>

        <div class="legend">
            <div class="legend-item">
                <div class="legend-color" style="background: #FF6B6B;"></div>
                <span>ÏôºÏ™Ω Ï£ºÎ®π</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #4ECDC4;"></div>
                <span>Ïò§Î•∏Ï™Ω Ï£ºÎ®π</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #FFD93D;"></div>
                <span>ÏôºÏ™Ω Îàà</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #95E1D3;"></div>
                <span>Ïò§Î•∏Ï™Ω Îàà</span>
            </div>
        </div>

        <div class="video-container">
            <video id="videoElement" autoplay playsinline></video>
            <canvas id="canvasElement"></canvas>
        </div>

        <div class="status-panel">
            <div class="status-item">
                <span class="status-label">ÏÜçÎèÑ Îã®Í≥Ñ</span>
                <span class="status-value" id="speedStatus">0Îã®</span>
            </div>
            <div class="status-item">
                <span class="status-label">Î∞©Ìñ•</span>
                <span class="status-value" id="directionStatus">Ï†ïÏßÄ</span>
            </div>
            <div class="status-item">
                <span class="status-label">ÏÑúÎ≥¥Î™®ÌÑ∞</span>
                <span class="status-value" id="servoStatus">ÎåÄÍ∏∞</span>
            </div>
            <div class="status-item">
                <span class="status-label">Ï£ºÌñâ Î™®Îìú</span>
                <span class="status-value" id="modeStatus">Ï†ïÏßÄ</span>
            </div>
        </div>

        <div class="log-panel" id="logPanel">
            <div class="log-item">Î°úÍ∑∏Í∞Ä Ïó¨Í∏∞Ïóê ÌëúÏãúÎê©ÎãàÎã§...</div>
        </div>
    </div>

    <div class="footer">
        <hr>
        2025 Teacher Jun, Dept. of Robotics Mechanical Design, Seoul Robotics Highschool
    </div>

    <script>
        let bleDevice = null;
        let bleCharacteristic = null;
        let camera = null;
        let pose = null;
        let faceMesh = null;
        
        const video = document.getElementById('videoElement');
        const canvas = document.getElementById('canvasElement');
        const canvasCtx = canvas.getContext('2d');
        
        let currentSpeed = 0;
        let currentDirection = 'straight';
        let lastCommand = '';
        let leftEyeClosedTime = 0;
        let rightEyeClosedTime = 0;
        let isLeftEyeClosed = false;
        let isRightEyeClosed = false;
        let lastDistance = 0;

        const SPEED_INCREASE_CMD = '3';
        const SPEED_DECREASE_CMD = '1';
        const STOP_CMD = '5';
        const RIGHT_TURN_CMD = '6';
        const LEFT_TURN_CMD = '4';
        const SERVO_LEFT_CMD = '7';
        const SERVO_RIGHT_CMD = '9';
        const BACKWARD_CMD = '2';
        const FORWARD_CMD = '8';

        const ANGLE_DEADZONE = 15;
        const STOP_THRESHOLD = 0.12;
        const DEADZONE_THRESHOLD = 0.16;
        const EYE_CLOSED_DURATION = 500;

        document.getElementById('connectBtn').addEventListener('click', connectBLE);
        document.getElementById('startBtn').addEventListener('click', startCamera);

        async function connectBLE() {
            try {
                bleDevice = await navigator.bluetooth.requestDevice({
                    acceptAllDevices: true,
                    optionalServices: ['00c0ffee-1234-1234-1234-123456789abc']
                });

                const server = await bleDevice.gatt.connect();
                const service = await server.getPrimaryService('00c0ffee-1234-1234-1234-123456789abc');
                bleCharacteristic = await service.getCharacteristic('00c0ffee-4321-4321-4321-cba987654321');

                document.getElementById('bleStatus').textContent = 'BLE Ïó∞Í≤∞Îê®: ' + bleDevice.name;
                document.getElementById('bleStatus').className = 'ble-status ble-connected';
                document.getElementById('startBtn').disabled = false;
                addLog('BLE Í∏∞Í∏∞ Ïó∞Í≤∞ ÏÑ±Í≥µ: ' + bleDevice.name);

                bleDevice.addEventListener('gattserverdisconnected', () => {
                    addLog('BLE Ïó∞Í≤∞ ÎÅäÍπÄ');
                    document.getElementById('bleStatus').textContent = 'BLE Ïó∞Í≤∞ ÎÅäÍπÄ';
                    document.getElementById('bleStatus').className = 'ble-status ble-disconnected';
                    bleCharacteristic = null;
                });
            } catch (error) {
                addLog('BLE Ïó∞Í≤∞ Ïã§Ìå®: ' + error);
                alert('BLE Ïó∞Í≤∞ Ïã§Ìå®: ' + error);
            }
        }

        async function sendBLECommand(command) {
            if (bleCharacteristic && command !== lastCommand) {
                try {
                    const encoder = new TextEncoder();
                    await bleCharacteristic.writeValue(encoder.encode(command + '\n'));
                    lastCommand = command;
                } catch (error) {
                    console.error('BLE Ï†ÑÏÜ° Ïã§Ìå®:', error);
                }
            }
        }

        function startCamera() {
            pose = new Pose({
                locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`
            });

            pose.setOptions({
                modelComplexity: 1,
                smoothLandmarks: true,
                enableSegmentation: false,
                minDetectionConfidence: 0.5,
                minTrackingConfidence: 0.5
            });

            faceMesh = new FaceMesh({
                locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`
            });

            faceMesh.setOptions({
                maxNumFaces: 1,
                refineLandmarks: true,
                minDetectionConfidence: 0.5,
                minTrackingConfidence: 0.5
            });

            pose.onResults(onPoseResults);
            faceMesh.onResults(onFaceResults);

            camera = new Camera(video, {
                onFrame: async () => {
                    await pose.send({ image: video });
                    await faceMesh.send({ image: video });
                },
                width: 480,
                height: 640
            });

            camera.start();
            document.getElementById('startBtn').disabled = true;
            addLog('Ïπ¥Î©îÎùº ÏãúÏûëÎê®');
        }

        let faceResults = null;

        function onFaceResults(results) {
            faceResults = results;
        }

        function onPoseResults(results) {
            if (video.videoWidth && video.videoHeight) {
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
            }

            canvasCtx.save();
            canvasCtx.clearRect(0, 0, canvas.width, canvas.height);
            canvasCtx.translate(canvas.width, 0);
            canvasCtx.scale(-1, 1);
            canvasCtx.drawImage(video, 0, 0, canvas.width, canvas.height);

            if (results.poseLandmarks) {
                const leftWrist = {
                    x: results.poseLandmarks[15].x,
                    y: results.poseLandmarks[15].y - 0.05,
                    visibility: results.poseLandmarks[15].visibility
                };
                const rightWrist = {
                    x: results.poseLandmarks[16].x,
                    y: results.poseLandmarks[16].y - 0.05,
                    visibility: results.poseLandmarks[16].visibility
                };

                if (leftWrist.visibility > 0.5 && rightWrist.visibility > 0.5) {
                    if (leftWrist.x < 0 || leftWrist.x > 1 || leftWrist.y < 0 || leftWrist.y > 1 ||
                        rightWrist.x < 0 || rightWrist.x > 1 || rightWrist.y < 0 || rightWrist.y > 1) {
                        sendBLECommand(STOP_CMD);
                        updateStatus(0, 'straight', 'Ï†ïÏßÄ');
                        addLog('Ï£ºÎ®πÏù¥ ÌôîÎ©¥ Î∞ñ - Ï†ïÏßÄ');
                    } else {
                        drawPoint(canvasCtx, leftWrist, '#FF6B6B', 18);
                        drawPoint(canvasCtx, rightWrist, '#4ECDC4', 18);

                        const leftFistCanvas = {
                            x: leftWrist.x * canvas.width,
                            y: leftWrist.y * canvas.height
                        };
                        const rightFistCanvas = {
                            x: rightWrist.x * canvas.width,
                            y: rightWrist.y * canvas.height
                        };

                        canvasCtx.beginPath();
                        canvasCtx.moveTo(leftFistCanvas.x, leftFistCanvas.y);
                        canvasCtx.lineTo(rightFistCanvas.x, rightFistCanvas.y);
                        canvasCtx.strokeStyle = '#667eea';
                        canvasCtx.lineWidth = 4;
                        canvasCtx.setLineDash([10, 5]);
                        canvasCtx.stroke();
                        canvasCtx.setLineDash([]);

                        processWristControl(leftWrist, rightWrist);
                    }
                } else {
                    sendBLECommand(STOP_CMD);
                    updateStatus(0, 'straight', 'Ï†ïÏßÄ');
                }
            }

            if (faceResults && faceResults.multiFaceLandmarks && faceResults.multiFaceLandmarks[0]) {
                const landmarks = faceResults.multiFaceLandmarks[0];
                
                const leftEyeTop = landmarks[159];
                const leftEyeBottom = landmarks[145];
                const leftEyeLeft = landmarks[33];
                const leftEyeRight = landmarks[133];

                const rightEyeTop = landmarks[386];
                const rightEyeBottom = landmarks[374];
                const rightEyeLeft = landmarks[362];
                const rightEyeRight = landmarks[263];

                drawEye(canvasCtx, [leftEyeTop, leftEyeBottom, leftEyeLeft, leftEyeRight], '#FFD93D');
                drawEye(canvasCtx, [rightEyeTop, rightEyeBottom, rightEyeLeft, rightEyeRight], '#95E1D3');

                processEyeControl(
                    leftEyeTop, leftEyeBottom, leftEyeLeft, leftEyeRight,
                    rightEyeTop, rightEyeBottom, rightEyeLeft, rightEyeRight
                );
            }

            canvasCtx.restore();
        }

        function drawPoint(ctx, point, color, size) {
            ctx.beginPath();
            ctx.arc(point.x * canvas.width, point.y * canvas.height, size, 0, 2 * Math.PI);
            ctx.fillStyle = color;
            ctx.fill();
            
            ctx.beginPath();
            ctx.arc(point.x * canvas.width - 3, point.y * canvas.height - 3, 6, 0, 2 * Math.PI);
            ctx.fillStyle = 'rgba(255, 255, 255, 0.4)';
            ctx.fill();
            
            ctx.beginPath();
            ctx.arc(point.x * canvas.width, point.y * canvas.height, size, 0, 2 * Math.PI);
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.8)';
            ctx.lineWidth = 3;
            ctx.stroke();
        }

        function drawEye(ctx, points, color) {
            points.forEach(point => {
                ctx.beginPath();
                ctx.arc(point.x * canvas.width, point.y * canvas.height, 12, 0, 2 * Math.PI);
                ctx.fillStyle = color;
                ctx.fill();
                
                ctx.beginPath();
                ctx.arc(point.x * canvas.width - 2, point.y * canvas.height - 2, 4, 0, 2 * Math.PI);
                ctx.fillStyle = 'rgba(255, 255, 255, 0.5)';
                ctx.fill();
                
                ctx.beginPath();
                ctx.arc(point.x * canvas.width, point.y * canvas.height, 12, 0, 2 * Math.PI);
                ctx.strokeStyle = 'rgba(255, 255, 255, 0.9)';
                ctx.lineWidth = 2.5;
                ctx.stroke();
            });
        }

        function processWristControl(leftWrist, rightWrist) {
            const distance = Math.sqrt(
                Math.pow(leftWrist.x - rightWrist.x, 2) +
                Math.pow(leftWrist.y - rightWrist.y, 2)
            );

            const angle = Math.atan2(
                rightWrist.y - leftWrist.y,
                rightWrist.x - leftWrist.x
            ) * 180 / Math.PI;

            const isCrossed = leftWrist.x > rightWrist.x;

            if (isCrossed) {
                if (currentSpeed !== 3) {
                    currentSpeed = 3;
                    sendBLECommand(BACKWARD_CMD);
                    updateStatus(3, 'straight', 'ÌõÑÏßÑ');
                    addLog('ÌõÑÏßÑ Î™®Îìú (3Îã® Í≥†Ï†ï)');
                }
                return;
            }

            if (distance < STOP_THRESHOLD || distance < DEADZONE_THRESHOLD) {
                if (currentSpeed !== 0) {
                    sendBLECommand(STOP_CMD);
                    currentSpeed = 0;
                    updateStatus(0, 'straight', 'Ï†ïÏßÄ');
                    addLog('Ï£ºÎ®π Í∑ºÏ†ë - Ï†ïÏßÄ');
                }
                return;
            }

            if (distance > lastDistance + 0.015) {
                if (currentSpeed < 5) {
                    sendBLECommand(SPEED_INCREASE_CMD);
                    currentSpeed++;
                    updateStatus(currentSpeed, currentDirection, 'Ï†ÑÏßÑ');
                    addLog(`ÏÜçÎèÑ Ï¶ùÍ∞Ä: ${currentSpeed}Îã®`);
                }
            } else if (distance < lastDistance - 0.015) {
                if (currentSpeed > 1) {
                    sendBLECommand(SPEED_DECREASE_CMD);
                    currentSpeed--;
                    updateStatus(currentSpeed, currentDirection, 'Ï†ÑÏßÑ');
                    addLog(`ÏÜçÎèÑ Í∞êÏÜå: ${currentSpeed}Îã®`);
                }
            }

            lastDistance = distance;

            let newDirection = 'straight';
            if (Math.abs(angle) <= ANGLE_DEADZONE) {
                newDirection = 'straight';
                if (currentDirection !== 'straight') {
                    sendBLECommand(FORWARD_CMD);
                    currentDirection = 'straight';
                    updateStatus(currentSpeed, currentDirection, 'Ï†ÑÏßÑ');
                    addLog('ÏßÅÏßÑ');
                }
            } else if (angle > ANGLE_DEADZONE) {
                newDirection = 'left';
                if (currentDirection !== 'left') {
                    sendBLECommand(LEFT_TURN_CMD);
                    currentDirection = 'left';
                    updateStatus(currentSpeed, currentDirection, 'Ï†ÑÏßÑ');
                    addLog('Ï¢åÌöåÏ†Ñ');
                }
            } else if (angle < -ANGLE_DEADZONE) {
                newDirection = 'right';
                if (currentDirection !== 'right') {
                    sendBLECommand(RIGHT_TURN_CMD);
                    currentDirection = 'right';
                    updateStatus(currentSpeed, currentDirection, 'Ï†ÑÏßÑ');
                    addLog('Ïö∞ÌöåÏ†Ñ');
                }
            }
        }

        function calculateEAR(eyeTop, eyeBottom, eyeLeft, eyeRight) {
            const verticalDist = Math.sqrt(
                Math.pow(eyeTop.x - eyeBottom.x, 2) +
                Math.pow(eyeTop.y - eyeBottom.y, 2)
            );
            const horizontalDist = Math.sqrt(
                Math.pow(eyeLeft.x - eyeRight.x, 2) +
                Math.pow(eyeLeft.y - eyeRight.y, 2)
            );
            return verticalDist / horizontalDist;
        }

        function processEyeControl(leftTop, leftBottom, leftLeft, leftRight,
                                   rightTop, rightBottom, rightLeft, rightRight) {
            const leftEAR = calculateEAR(leftTop, leftBottom, leftLeft, leftRight);
            const rightEAR = calculateEAR(rightTop, rightBottom, rightLeft, rightRight);

            const EAR_THRESHOLD = 0.2;

            const leftClosed = leftEAR < EAR_THRESHOLD;
            const rightClosed = rightEAR < EAR_THRESHOLD;

            const currentTime = Date.now();

            if (leftClosed && !isLeftEyeClosed) {
                isLeftEyeClosed = true;
                leftEyeClosedTime = currentTime;
            } else if (!leftClosed) {
                isLeftEyeClosed = false;
                leftEyeClosedTime = 0;
            }

            if (rightClosed && !isRightEyeClosed) {
                isRightEyeClosed = true;
                rightEyeClosedTime = currentTime;
            } else if (!rightClosed) {
                isRightEyeClosed = false;
                rightEyeClosedTime = 0;
            }

            if (isLeftEyeClosed && (currentTime - leftEyeClosedTime) >= EYE_CLOSED_DURATION) {
                sendBLECommand(SERVO_LEFT_CMD);
                document.getElementById('servoStatus').textContent = 'ÏôºÏ™Ω ÏûëÎèô';
                addLog('ÏôºÏ™Ω Îàà Í∞êÍπÄ - ÏÑúÎ≥¥Î™®ÌÑ∞ ÏûëÎèô');
                isLeftEyeClosed = false;
                leftEyeClosedTime = 0;
            }

            if (isRightEyeClosed && (currentTime - rightEyeClosedTime) >= EYE_CLOSED_DURATION) {
                sendBLECommand(SERVO_RIGHT_CMD);
                document.getElementById('servoStatus').textContent = 'Ïò§Î•∏Ï™Ω ÏûëÎèô';
                addLog('Ïò§Î•∏Ï™Ω Îàà Í∞êÍπÄ - ÏÑúÎ≥¥Î™®ÌÑ∞ Ïû¨ÏûëÎèô');
                isRightEyeClosed = false;
                rightEyeClosedTime = 0;
            }
        }

        function updateStatus(speed, direction, mode) {
            document.getElementById('speedStatus').textContent = speed + 'Îã®';
            
            let dirText = 'ÏßÅÏßÑ';
            if (direction === 'left') dirText = 'Ï¢åÌöåÏ†Ñ';
            else if (direction === 'right') dirText = 'Ïö∞ÌöåÏ†Ñ';
            document.getElementById('directionStatus').textContent = dirText;
            
            document.getElementById('modeStatus').textContent = mode;
        }

        function addLog(message) {
            const logPanel = document.getElementById('logPanel');
            const logItem = document.createElement('div');
            logItem.className = 'log-item';
            const timestamp = new Date().toLocaleTimeString();
            logItem.textContent = `[${timestamp}] ${message}`;
            logPanel.insertBefore(logItem, logPanel.firstChild);

            while (logPanel.children.length > 20) {
                logPanel.removeChild(logPanel.lastChild);
            }
        }
    </script>
</body>
</html>
